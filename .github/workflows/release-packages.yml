name: Create Release Packages

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: true
        default: '1.0.0-test'

jobs:
  build-packages:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Extract version from tag or input
        id: get_version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=${GITHUB_REF#refs/tags/v}
          fi
          if [ -z "$VERSION" ]; then
            echo "ERROR: Version extraction failed!"
            exit 1
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"
      
      # ===== VALIDATION STEPS =====
      - name: Validate Hook Files
        run: |
          echo "Validating hook files..."
          HOOKS_DIR="Mods/MoreRVers/scripts/hooks"
          REQUIRED_HOOKS=("game_session.lua" "join_gate.lua" "revive.lua" "throw_distance.lua" "speed_boost.lua" "ui_helpers.lua")
          MISSING_HOOKS=()
          
          for hook in "${REQUIRED_HOOKS[@]}"; do
            if [ ! -f "$HOOKS_DIR/$hook" ]; then
              MISSING_HOOKS+=("$hook")
            fi
          done
          
          if [ ${#MISSING_HOOKS[@]} -ne 0 ]; then
            echo "ERROR: Missing required hook files:"
            printf '  - %s\n' "${MISSING_HOOKS[@]}"
            exit 1
          fi
          
          echo "✓ All hook files present:"
          printf '  - %s\n' "${REQUIRED_HOOKS[@]}"
      
      - name: Validate Config File
        run: |
          echo "Validating config.ini..."
          CONFIG_FILE="Mods/MoreRVers/config.ini"
          
          if [ ! -f "$CONFIG_FILE" ]; then
            echo "ERROR: config.ini not found!"
            exit 1
          fi
          
          echo "Debug: Checking config file contents..."
          echo "First 30 lines of config.ini:"
          head -n 30 "$CONFIG_FILE" || true
          
          # Check for required sections and keys
          MISSING_CONFIG=()
          
          # Check MaxPlayers
          if ! grep -q "^MaxPlayers" "$CONFIG_FILE"; then
            MISSING_CONFIG+=("MaxPlayers")
            echo "Debug: MaxPlayers NOT found"
          else
            echo "Debug: MaxPlayers found"
          fi
          
          # Check Revive section
          if ! grep -q "^\[Revive\]" "$CONFIG_FILE"; then
            MISSING_CONFIG+=("Revive section header [Revive]")
            echo "Debug: [Revive] NOT found"
          else
            echo "Debug: [Revive] found"
          fi
          if ! grep -q "^ReviveEnabled" "$CONFIG_FILE"; then
            MISSING_CONFIG+=("ReviveEnabled key")
            echo "Debug: ReviveEnabled NOT found"
          else
            echo "Debug: ReviveEnabled found"
          fi
          if ! grep -q "^ReviveKeybind" "$CONFIG_FILE"; then
            MISSING_CONFIG+=("ReviveKeybind key")
            echo "Debug: ReviveKeybind NOT found"
          else
            echo "Debug: ReviveKeybind found"
          fi
          
          # Check Throw section
          if ! grep -q "^\[Throw\]" "$CONFIG_FILE"; then
            MISSING_CONFIG+=("Throw section header [Throw]")
            echo "Debug: [Throw] NOT found"
          else
            echo "Debug: [Throw] found"
          fi
          if ! grep -q "^ThrowDistanceMultiplier" "$CONFIG_FILE"; then
            MISSING_CONFIG+=("ThrowDistanceMultiplier key")
            echo "Debug: ThrowDistanceMultiplier NOT found"
          else
            echo "Debug: ThrowDistanceMultiplier found"
          fi
          
          # Check Speed section (new)
          if ! grep -q "^\[Speed\]" "$CONFIG_FILE"; then
            MISSING_CONFIG+=("Speed section header [Speed]")
            echo "Debug: [Speed] NOT found"
          else
            echo "Debug: [Speed] found"
          fi
          if ! grep -q "^SpeedBoostEnabled" "$CONFIG_FILE"; then
            MISSING_CONFIG+=("SpeedBoostEnabled key")
            echo "Debug: SpeedBoostEnabled NOT found"
          else
            echo "Debug: SpeedBoostEnabled found"
          fi
          if ! grep -q "^SpeedMultiplier" "$CONFIG_FILE"; then
            MISSING_CONFIG+=("SpeedMultiplier key")
            echo "Debug: SpeedMultiplier NOT found"
          else
            echo "Debug: SpeedMultiplier found"
          fi
          if ! grep -q "^SpeedKeybind" "$CONFIG_FILE"; then
            MISSING_CONFIG+=("SpeedKeybind key")
            echo "Debug: SpeedKeybind NOT found"
          else
            echo "Debug: SpeedKeybind found"
          fi
          
          if [ ${#MISSING_CONFIG[@]} -ne 0 ]; then
            echo "ERROR: Missing required config entries:"
            printf '  - %s\n' "${MISSING_CONFIG[@]}"
            echo ""
            echo "Debug: Showing all lines containing brackets:"
            grep -n "\[" "$CONFIG_FILE" || echo "No brackets found"
            echo ""
            echo "Debug: Showing all lines starting with Revive, Throw, or Speed:"
            grep -n "^Revive\|^Throw\|^Speed" "$CONFIG_FILE" || echo "No matching lines found"
            exit 1
          fi
          
          echo "✓ Config file validated - all sections present"
          echo "  - MaxPlayers"
          echo "  - [Revive] section (ReviveEnabled, ReviveKeybind)"
          echo "  - [Throw] section (ThrowDistanceMultiplier)"
          echo "  - [Speed] section (SpeedBoostEnabled, SpeedMultiplier, SpeedKeybind)"
      
      - name: Validate Mod Structure
        run: |
          echo "Validating mod structure..."
          MOD_DIR="Mods/MoreRVers"
          MISSING_FILES=()
          
          # Check critical files
          if [ ! -f "$MOD_DIR/mod.json" ]; then
            MISSING_FILES+=("mod.json")
          fi
          if [ ! -f "$MOD_DIR/config.ini" ]; then
            MISSING_FILES+=("config.ini")
          fi
          if [ ! -f "$MOD_DIR/scripts/main.lua" ]; then
            MISSING_FILES+=("scripts/main.lua")
          fi
          
          if [ ${#MISSING_FILES[@]} -ne 0 ]; then
            echo "ERROR: Missing critical mod files:"
            printf '  - %s\n' "${MISSING_FILES[@]}"
            exit 1
          fi
          
          # Verify main.lua loads speed_boost hook
          if ! grep -q "speed_boost" "$MOD_DIR/scripts/main.lua"; then
            echo "ERROR: main.lua does not load speed_boost hook!"
            exit 1
          fi
          
          echo "✓ Mod structure validated"
      
      - name: Prepare UE4SS files
        run: |
          echo "Using bundled UE4SS experimental..."
          echo "UE4SS files ready"
      
      # ===== MOD-ONLY PACKAGE =====
      - name: Create Mod-Only package structure
        run: |
          mkdir -p mod-only-package
          cp -r Mods/MoreRVers mod-only-package/
          cp README.md mod-only-package/
          cp LICENSE mod-only-package/
          
          # Remove Thunderstore-specific files
          rm -f mod-only-package/MoreRVers/manifest.json
          
          echo "Mod-Only package structure created"
      
      - name: Verify Mod-Only Package
        run: |
          echo "Verifying Mod-Only package..."
          PACKAGE_DIR="mod-only-package"
          
          # Count hook files
          HOOK_COUNT=$(find "$PACKAGE_DIR/MoreRVers/scripts/hooks" -name "*.lua" 2>/dev/null | wc -l)
          echo "  Hook files: $HOOK_COUNT"
          
          # Verify critical files
          if [ ! -f "$PACKAGE_DIR/MoreRVers/scripts/main.lua" ]; then
            echo "ERROR: main.lua missing in Mod-Only package!"
            exit 1
          fi
          if [ ! -f "$PACKAGE_DIR/MoreRVers/config.ini" ]; then
            echo "ERROR: config.ini missing in Mod-Only package!"
            exit 1
          fi
          if [ ! -f "$PACKAGE_DIR/README.md" ]; then
            echo "ERROR: README.md missing in Mod-Only package!"
            exit 1
          fi
          
          echo "✓ Mod-Only package verified"
      
      # ===== WITH-UE4SS PACKAGE =====
      - name: Create With-UE4SS package structure
        run: |
          mkdir -p with-ue4ss-package
          
          # UE4SS experimental has proper subdirectory structure - maintain it!
          cp ue4ss-experimental/dwmapi.dll with-ue4ss-package/
          cp -r ue4ss-experimental/ue4ss with-ue4ss-package/
          
          # Copy mod files to the Mods directory
          cp -r Mods/MoreRVers with-ue4ss-package/ue4ss/Mods/
          
          # Remove Thunderstore-specific files
          rm -f with-ue4ss-package/ue4ss/Mods/MoreRVers/manifest.json
          
          # Update mods.txt to enable MoreRVers (add before Keybinds line)
          sed -i '/^Keybinds/i MoreRVers : 1\n' with-ue4ss-package/ue4ss/Mods/mods.txt
          
          # Enable console in UE4SS settings
          sed -i 's/^ConsoleEnabled = 0/ConsoleEnabled = 1/' with-ue4ss-package/ue4ss/UE4SS-settings.ini
          
          # Add README
          cp README.md with-ue4ss-package/
          cp LICENSE with-ue4ss-package/
          
          echo "With-UE4SS package structure created"
      
      - name: Verify With-UE4SS Package
        run: |
          echo "Verifying With-UE4SS package..."
          PACKAGE_DIR="with-ue4ss-package"
          
          # Count hook files
          HOOK_COUNT=$(find "$PACKAGE_DIR/ue4ss/Mods/MoreRVers/scripts/hooks" -name "*.lua" 2>/dev/null | wc -l)
          echo "  Hook files: $HOOK_COUNT"
          
          # Verify critical files
          if [ ! -f "$PACKAGE_DIR/ue4ss/Mods/MoreRVers/scripts/main.lua" ]; then
            echo "ERROR: main.lua missing in With-UE4SS package!"
            exit 1
          fi
          if [ ! -f "$PACKAGE_DIR/ue4ss/Mods/MoreRVers/config.ini" ]; then
            echo "ERROR: config.ini missing in With-UE4SS package!"
            exit 1
          fi
          if [ ! -f "$PACKAGE_DIR/ue4ss/UE4SS.dll" ]; then
            echo "ERROR: UE4SS.dll missing in With-UE4SS package!"
            exit 1
          fi
          if [ ! -f "$PACKAGE_DIR/README.md" ]; then
            echo "ERROR: README.md missing in With-UE4SS package!"
            exit 1
          fi
          
          # Verify mods.txt contains MoreRVers
          if ! grep -q "^MoreRVers" "$PACKAGE_DIR/ue4ss/Mods/mods.txt"; then
            echo "ERROR: MoreRVers not enabled in mods.txt!"
            exit 1
          fi
          
          echo "✓ With-UE4SS package verified"
      
      # ===== CREATE ZIP FILES =====
      - name: Create Mod-Only ZIP
        run: |
          cd mod-only-package
          zip -r ../MoreRVers-v${{ steps.get_version.outputs.version }}-ModOnly.zip .
          cd ..
      
      - name: Create With-UE4SS ZIP
        run: |
          cd with-ue4ss-package
          zip -r ../MoreRVers-v${{ steps.get_version.outputs.version }}-WithUE4SS.zip .
          cd ..
      
      # ===== UPLOAD ARTIFACTS (for manual testing) =====
      - name: Upload artifacts for testing
        if: github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: release-packages
          path: |
            MoreRVers-v${{ steps.get_version.outputs.version }}-ModOnly.zip
            MoreRVers-v${{ steps.get_version.outputs.version }}-WithUE4SS.zip
          retention-days: 7
      
      # ===== UPLOAD TO RELEASE (for actual releases) =====
      - name: Upload Release Assets
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: |
            MoreRVers-v${{ steps.get_version.outputs.version }}-ModOnly.zip
            MoreRVers-v${{ steps.get_version.outputs.version }}-WithUE4SS.zip
      
      - name: Summary
        run: |
          echo "=========================================="
          echo "  Release Packages Created Successfully!"
          echo "=========================================="
          echo ""
          echo "Version: ${{ steps.get_version.outputs.version }}"
          echo ""
          echo "Generated files:"
          echo "  ✓ MoreRVers-v${{ steps.get_version.outputs.version }}-ModOnly.zip"
          echo "  ✓ MoreRVers-v${{ steps.get_version.outputs.version }}-WithUE4SS.zip"
          echo ""
          echo "Features included:"
          echo "  • MaxPlayers - Configurable player limit (1-24)"
          echo "  • Revive System - Configurable keybind to revive/respawn players"
          echo "  • Enhanced Throw Distance - Configurable multiplier for throw distance"
          echo "  • Speed Boost - Configurable movement speed multiplier with toggle keybind"
          echo ""
          echo "Hook files packaged:"
          echo "  • game_session.lua"
          echo "  • join_gate.lua"
          echo "  • revive.lua"
          echo "  • throw_distance.lua"
          echo "  • speed_boost.lua (NEW)"
          echo "  • ui_helpers.lua"
          echo ""
          echo "Package contents:"
          MOD_ONLY_SIZE=$(du -h MoreRVers-v${{ steps.get_version.outputs.version }}-ModOnly.zip | cut -f1)
          WITH_UE4SS_SIZE=$(du -h MoreRVers-v${{ steps.get_version.outputs.version }}-WithUE4SS.zip | cut -f1)
          echo "  • Mod-Only: $MOD_ONLY_SIZE"
          echo "  • With-UE4SS: $WITH_UE4SS_SIZE"
          echo ""
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo "  TEST MODE: Packages uploaded as artifacts"
            echo "  Available for 7 days"
            echo "  Download from: Actions tab → This workflow run → Artifacts section"
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          else
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo "  RELEASE MODE: Packages uploaded to release"
            echo "  Available at: ${{ github.event.release.html_url }}"
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          fi
          echo ""

